services:
  app:
    build:
      context: .
    env_file:
      - .env.production
    environment:
      NODE_ENV: production
    expose:
      - "3000"
    networks:
      - proxy
    healthcheck:
      # Next.js standalone can bind to the container hostname/IP (not loopback),
      # so healthcheck should target the same hostname to avoid false negatives.
      test: ["CMD", "node", "-e", "fetch('http://' + (process.env.HOSTNAME || 'localhost') + ':3000/health').then(r=>{if(!r.ok) process.exit(1);}).catch(()=>process.exit(1));"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    labels:
      - traefik.enable=true
      # Ensure Traefik reaches this container via the shared "proxy" network.
      - traefik.docker.network=proxy
      # Explicitly bind the routers to the app's listening port.
      - traefik.http.services.cobracco.loadbalancer.server.port=3000
      - traefik.http.routers.app.rule=Host(`www.cobracco.it`)
      - traefik.http.routers.app.entrypoints=websecure
      - traefik.http.routers.app.tls.certresolver=le
      - traefik.http.routers.app.service=cobracco
      - traefik.http.routers.app.middlewares=security-headers


      - traefik.http.routers.static.rule=Host(`www.cobracco.it`) && (PathPrefix(`/_next/static/`) || Path(`/favicon.ico`))
      - traefik.http.routers.static.entrypoints=websecure
      - traefik.http.routers.static.tls.certresolver=le
      - traefik.http.routers.static.service=cobracco
      - traefik.http.routers.static.middlewares=security-headers,static-cache

      - traefik.http.middlewares.static-cache.headers.customResponseHeaders.Cache-Control=public, max-age=31536000, immutable

      - traefik.http.middlewares.security-headers.headers.contentTypeNosniff=true
      - traefik.http.middlewares.security-headers.headers.frameDeny=true
      - traefik.http.middlewares.security-headers.headers.referrerPolicy=strict-origin-when-cross-origin
      - traefik.http.middlewares.security-headers.headers.permissionsPolicy=geolocation=(), microphone=(), camera=()
      - traefik.http.middlewares.security-headers.headers.stsSeconds=31536000
      - traefik.http.middlewares.security-headers.headers.stsIncludeSubdomains=true
      - traefik.http.middlewares.security-headers.headers.stsPreload=true
      - "traefik.http.middlewares.security-headers.headers.customResponseHeaders.Content-Security-Policy=default-src 'self'; img-src 'self' data: https: https://googleads.g.doubleclick.net https://www.googleadservices.com; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' https://www.google.com https://www.gstatic.com https://www.googletagmanager.com; connect-src 'self' https: https://www.google.com https://www.google-analytics.com https://region1.google-analytics.com https://www.googletagmanager.com https://googleads.g.doubleclick.net https://www.googleadservices.com; frame-src https://www.google.com; frame-ancestors 'none'; base-uri 'self'; form-action 'self'"
networks:
  proxy:
    external: true
